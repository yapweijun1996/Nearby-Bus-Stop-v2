<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nearby Bus Stops</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:sans-serif; height:100vh; display:flex }
    #map { flex:1 }
    #panel {
      width:300px; max-width:100%; background:#fff;
      box-shadow:-2px 0 5px rgba(0,0,0,0.1);
      display:flex; flex-direction:column;
    }
    #panel header {
      padding:1rem; background:#0066cc;
      color:#fff; text-align:center; font-size:1.2rem;
    }
    #controls {
      display:flex; flex-direction:column; padding:0.5rem 1rem;
      border-bottom:1px solid #eee;
    }
    #controls input {
      margin-bottom:0.5rem; padding:0.5rem; border:1px solid #ccc;
      border-radius:4px;
    }
    #search {
      display:flex;
    }
    #search input {
      flex:1; padding:.5rem; border:1px solid #ccc;
      border-radius:4px 0 0 4px;
    }
    #search button {
      padding:.5rem 1rem; border:none; background:#005fa3;
      color:#fff; border-radius:0 4px 4px 0; cursor:pointer;
    }
    #search button:hover { background:#004a7c }
    #status { padding:.75rem 1rem; font-size:.9rem; color:#333 }
    #stops { list-style:none; overflow-y:auto; flex:1 }
    #stops li {
      padding:.75rem 1rem; border-bottom:1px solid #eee;
      cursor:pointer; transition:background .2s;
    }
    #stops li:hover { background:#f5f5f5 }
    .stop-name { font-weight:bold }
    .stop-code a {
      display:inline-block; margin-top:.25rem;
      font-size:.85rem; color:#0066cc; text-decoration:none;
    }
    .distance { font-size:.85rem; color:#666; margin-top:.25rem }
    @media(max-width:600px){
      body { flex-direction:column }
      #map { height:60vh }
      #panel {
        width:100%; height:40vh;
        box-shadow:0 -2px 5px rgba(0,0,0,0.1);
      }
    }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="panel">
    <header>Nearby Bus Stops</header>
    <div id="controls">
      <input id="radiusInput" type="number" step="0.1" min="0.1" value="1.55" />
      <label for="radiusInput">Radius (km)</label>
    </div>
    <div id="search">
      <input id="searchInput" placeholder="Search location…" />
      <button id="searchBtn">Find</button>
    </div>
    <div id="status">Initializing…</div>
    <ul id="stops"></ul>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const DEFAULT = { lat: 1.2834, lon: 103.8607 };

    async function geocode(q) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=sg&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers:{ 'User-Agent':'NearbyBusStopsApp' } });
      const js = await res.json();
      if (!js.length) throw new Error('Location not found');
      return {
        lat: +js[0].lat,
        lon: +js[0].lon,
        name: js[0].display_name
      };
    }

    async function renderNearby(lat, lon, msg) {
      document.getElementById('status').textContent = msg;
      const stopsEl = document.getElementById('stops');

      if (!window._map) {
        window._map = L.map('map', { zoomControl:false }).setView([lat,lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:'&copy; OpenStreetMap contributors'
        }).addTo(window._map);
      }
      const map = window._map;

      // clear
      stopsEl.innerHTML = '';
      if (window._markers) window._markers.forEach(m=>map.removeLayer(m));
      window._markers = [];

      // reference marker
      const ref = L.circleMarker([lat,lon], {
        radius:8, color:'#0066cc', fillColor:'#0066cc', fillOpacity:0.8
      }).addTo(map).bindPopup('Reference point').openPopup();
      window._markers.push(ref);

      // read radius (km) from input, convert to meters
      const R_km = parseFloat(document.getElementById('radiusInput').value) || 1.55;
      const radius_m = Math.round(R_km * 1000);

      // fetch from proxy with radius
      const proxyUrl = `busStops.php?lat=${lat}&lon=${lon}&radius=${radius_m}`;
      const res = await fetch(proxyUrl);
      if (!res.ok) throw new Error('BusStops proxy error');
      const { value: nearest } = await res.json();

      // fit bounds
      const fg = L.featureGroup(nearest.map(s=>L.marker([s.Latitude,s.Longitude])).concat(ref));
      map.fitBounds(fg.getBounds().pad(0.3));

      // plot
      nearest.forEach(s=>{
        const d = (map.distance([lat,lon],[s.Latitude,s.Longitude])/1000).toFixed(2);
        const url = `https://yapweijun1996.github.io/SG-Bus-Arrival-Time-By-Bus-Code/?busId=${s.BusStopCode}`;
        const m = L.marker([s.Latitude,s.Longitude]).addTo(map)
          .bindPopup(`<b>${s.Description}</b><br>
                      <small>Code: ${s.BusStopCode}</small><br>
                      ${d} km away`);
        window._markers.push(m);

        const li = document.createElement('li');
        li.innerHTML = `
          <div class="stop-name">${s.Description}</div>
          <div class="stop-code"><a href="${url}" target="_blank">Code: ${s.BusStopCode}</a></div>
          <div class="distance">${d} km away</div>`;
        li.onclick = ()=>{ map.setView(m.getLatLng(),16); m.openPopup(); };
        stopsEl.appendChild(li);
      });
    }

    (async()=>{
      const p = new URLSearchParams(location.search);

      if (p.has('lat')&&p.has('lon')) {
        await renderNearby(+p.get('lat'),+p.get('lon'),
          `URL coords: ${(+p.get('lat')).toFixed(5)},${(+p.get('lon')).toFixed(5)}`);
      }
      else if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos=> renderNearby(pos.coords.latitude,pos.coords.longitude,
            `You are at ${pos.coords.latitude.toFixed(5)},${pos.coords.longitude.toFixed(5)}`),
          ()=> renderNearby(DEFAULT.lat,DEFAULT.lon,'Geo denied; default'),
          {enableHighAccuracy:true,timeout:5000,maximumAge:0}
        );
      }
      else {
        await renderNearby(DEFAULT.lat,DEFAULT.lon,'No geo; default');
      }

      document.getElementById('searchBtn').onclick = async ()=>{
        const q = document.getElementById('searchInput').value.trim();
        if (!q) return;
        try {
          document.getElementById('status').textContent = 'Searching…';
          const {lat,lon,name} = await geocode(q);
          await renderNearby(lat,lon,`Search result: ${name}`);
        } catch(e) {
          document.getElementById('status').textContent = e.message;
        }
      };
    })();
  </script>
</body>
</html>
