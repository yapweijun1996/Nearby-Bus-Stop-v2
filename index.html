<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nearby Bus Stops</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #map { height: 60vh; }
    #controls { padding: 1em; background: #f7f7f7; }
    #stops { padding: 1em; max-height: 30vh; overflow: auto; }
    label { margin-right: 0.5em; }
    .stop-item { margin-bottom: 0.5em; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="locate">Use My Location</button>
    <input type="text" id="search" placeholder="Search place…">
    <button id="doSearch">Go</button>
    <label>
      Radius:
      <input type="range" id="radius" min="0.1" max="5" step="0.1" value="1">
      <span id="radiusVal">1.0</span> km
    </label>
  </div>
  <div id="map"></div>
  <div id="stops"></div>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    console.log('App init');

    const map = L.map('map').setView([1.3521, 103.8198], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OSM contributors'
    }).addTo(map);

    let userMarker, stopMarkers = [];

    const radiusInput = document.getElementById('radius');
    const radiusVal = document.getElementById('radiusVal');
    radiusInput.addEventListener('input', () => {
      radiusVal.textContent = parseFloat(radiusInput.value).toFixed(1);
    });

    document.getElementById('locate').addEventListener('click', () => {
      console.log('→ requesting geolocation');
      navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError);
    });

    document.getElementById('doSearch').addEventListener('click', () => {
      const q = document.getElementById('search').value.trim();
      if (!q) return alert('Enter a place to search');
      console.log('→ geocode()', q);
      fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sg&limit=1&q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(results => {
          if (!results.length) throw new Error('No results');
          const { lat, lon, display_name } = results[0];
          console.log('← geocode result', display_name, lat, lon);
          renderNearby({ lat: +lat, lon: +lon, msg: display_name });
        })
        .catch(err => {
          console.error('✗ geocode failed', err);
          alert('Place not found');
        });
    });

    function onGeoSuccess(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      console.log('← geolocation success', lat, lon);
      renderNearby({ lat, lon, msg: `You are at ${lat.toFixed(5)},${lon.toFixed(5)}` });
    }

    function onGeoError(err) {
      console.error('✗ geolocation error', err);
      alert('Failed to get location');
    }

    function renderNearby({ lat, lon, msg }) {
      console.log('renderNearby()', { lat, lon, msg });
      map.setView([lat, lon], 15);
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat, lon]).addTo(map).bindPopup(msg).openPopup();

      const radius_km = parseFloat(radiusInput.value);
      console.log(`→ fetch stops (radius_km=${radius_km})`);
      const proxyUrl = 
        `https://yapweijun1996.com/api/LTA_DataMall/busStops.php` +
        `?lat=${lat}&lon=${lon}&radius_km=${radius_km}`;

      fetch(proxyUrl)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(json => {
          console.log('← stops response', json);
          showStops(json.value || []);
        })
        .catch(err => {
          console.error('✗ stops fetch failed', err);
          alert('Failed to load bus stops');
        });
    }

    function showStops(stops) {
      console.log('→ plotting', stops.length, 'stops');
      stopMarkers.forEach(m => map.removeLayer(m));
      stopMarkers = [];
      const list = document.getElementById('stops');
      list.innerHTML = '';

      stops.forEach(s => {
        // now using distance_km
        const d = s.distance_km;
        console.log(` • ${s.BusStopCode} ${d.toFixed(2)} km`);
        const div = document.createElement('div');
        div.className = 'stop-item';
        div.textContent = 
          `${s.BusStopCode} – ${s.Description} (${d.toFixed(2)} km)`;
        list.appendChild(div);

        const marker = L.marker([s.Latitude, s.Longitude])
          .addTo(map)
          .bindPopup(`${s.BusStopCode}: ${s.Description}<br>${d.toFixed(2)} km`);
        stopMarkers.push(marker);
      });
    }

    // auto-locate on load
    document.getElementById('locate').click();
  </script>
</body>
</html>
